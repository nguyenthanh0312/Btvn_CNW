<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CRUD Users - JSONPlaceholder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }

    h1 {
      text-align: center;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .error {
      background: #ffe5e5;
      color: #b10000;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      display: none;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .top-bar input[type="text"] {
      padding: 8px;
      width: 240px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .top-bar button {
      padding: 8px 12px;
      border-radius: 4px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }

    .top-bar button:hover {
      background: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #f0f0f0;
    }

    .actions button {
      margin-right: 5px;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .btn-edit {
      background: #ffc107;
      color: #000;
    }
    .btn-edit:hover {
      background: #e0a800;
    }

    .btn-delete {
      background: #dc3545;
      color: #fff;
    }
    .btn-delete:hover {
      background: #c82333;
    }

    /* Pagination */
    .pagination {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pagination button {
      border: 1px solid #ccc;
      background: #fff;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
    }

    .pagination button.active {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .pagination button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      padding: 20px;
      width: 400px;
      max-width: 90%;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .modal h2 {
      margin-top: 0;
    }

    .modal form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal label {
      font-weight: bold;
    }

    .modal input[type="text"],
    .modal input[type="email"],
    .modal input[type="tel"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }

    .modal .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .modal .buttons button {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .btn-cancel {
      background: #6c757d;
      color: #fff;
    }

    .btn-save {
      background: #28a745;
      color: #fff;
    }

    .btn-cancel:hover {
      background: #5a6268;
    }

    .btn-save:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CRUD Users - JSONPlaceholder</h1>

    <div id="errorBox" class="error"></div>

    <div class="top-bar">
      <div>
        <strong>Search by name:</strong>
        <input type="text" id="searchInput" placeholder="Type name..." />
      </div>
      <button id="btnAddUser">+ Add User</button>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 30%;">Name</th>
          <th style="width: 35%;">Email</th>
          <th style="width: 20%;">Phone</th>
          <th style="width: 15%;">Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <!-- Rows will be injected here -->
      </tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Modal for Create / Edit -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2 id="modalTitle">Add User</h2>
      <form id="userForm">
        <input type="hidden" id="userId" />
        <div>
          <label for="nameInput">Name</label>
          <input type="text" id="nameInput" required />
        </div>
        <div>
          <label for="emailInput">Email</label>
          <input type="email" id="emailInput" required />
        </div>
        <div>
          <label for="phoneInput">Phone</label>
          <input type="tel" id="phoneInput" required />
        </div>
        <div class="buttons">
          <button type="button" class="btn-cancel" id="btnCancelModal">Cancel</button>
          <button type="submit" class="btn-save">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = "https://jsonplaceholder.typicode.com/users";

    const errorBox = document.getElementById("errorBox");
    const searchInput = document.getElementById("searchInput");
    const usersTableBody = document.getElementById("usersTableBody");
    const paginationEl = document.getElementById("pagination");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const userForm = document.getElementById("userForm");
    const userIdInput = document.getElementById("userId");
    const nameInput = document.getElementById("nameInput");
    const emailInput = document.getElementById("emailInput");
    const phoneInput = document.getElementById("phoneInput");
    const btnAddUser = document.getElementById("btnAddUser");
    const btnCancelModal = document.getElementById("btnCancelModal");

    // State
    let users = [];       // mảng tất cả users (frontend)
    let currentPage = 1;
    const pageSize = 5;

    // Helper: show / hide error
    function showError(message) {
      errorBox.textContent = message;
      errorBox.style.display = "block";
    }

    function clearError() {
      errorBox.textContent = "";
      errorBox.style.display = "none";
    }

    // Helper: open / close modal
    function openModal(mode, user = null) {
      if (mode === "create") {
        modalTitle.textContent = "Add User";
        userIdInput.value = "";
        nameInput.value = "";
        emailInput.value = "";
        phoneInput.value = "";
      } else if (mode === "edit" && user) {
        modalTitle.textContent = "Edit User";
        userIdInput.value = user.id;
        nameInput.value = user.name;
        emailInput.value = user.email;
        phoneInput.value = user.phone;
      }
      modalBackdrop.style.display = "flex";
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
    }

    // Fetch users from API
    async function fetchUsers() {
      try {
        clearError();
        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error("Failed to fetch users. Status: " + response.status);
        }
        const data = await response.json();
        users = data;  // lưu vào state
        currentPage = 1;
        renderUsers();
        renderPagination();
      } catch (err) {
        showError(err.message);
      }
    }

    // Render table từ state + search + pagination
    function renderUsers() {
      const searchTerm = searchInput.value.trim().toLowerCase();

      // Filter by name
      const filteredUsers = users.filter(u =>
        u.name.toLowerCase().includes(searchTerm)
      );

      // Pagination
      const totalItems = filteredUsers.length;
      const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const usersToShow = filteredUsers.slice(startIndex, endIndex);

      usersTableBody.innerHTML = "";

      if (usersToShow.length === 0) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center;">No users found.</td>
          </tr>
        `;
        return;
      }

      for (const user of usersToShow) {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.phone}</td>
          <td class="actions">
            <button class="btn-edit" data-id="${user.id}">Edit</button>
            <button class="btn-delete" data-id="${user.id}">Delete</button>
          </td>
        `;

        usersTableBody.appendChild(tr);
      }
    }

    // Render pagination buttons
    function renderPagination() {
      const searchTerm = searchInput.value.trim().toLowerCase();
      const filteredUsers = users.filter(u =>
        u.name.toLowerCase().includes(searchTerm)
      );

      const totalItems = filteredUsers.length;
      const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));

      paginationEl.innerHTML = "";

      // Prev
      const prevBtn = document.createElement("button");
      prevBtn.textContent = "Prev";
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderUsers();
          renderPagination();
        }
      });
      paginationEl.appendChild(prevBtn);

      // Numbered pages
      for (let page = 1; page <= totalPages; page++) {
        const btn = document.createElement("button");
        btn.textContent = page;
        if (page === currentPage) {
          btn.classList.add("active");
        }
        btn.addEventListener("click", () => {
          currentPage = page;
          renderUsers();
          renderPagination();
        });
        paginationEl.appendChild(btn);
      }

      // Next
      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderUsers();
          renderPagination();
        }
      });
      paginationEl.appendChild(nextBtn);
    }

    // Create user (POST)
    async function createUser(newUser) {
      try {
        clearError();
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(newUser)
        });

        if (!response.ok) {
          throw new Error("Failed to create user. Status: " + response.status);
        }

        const created = await response.json();
        // jsonplaceholder trả về id giả -> ta vẫn dùng để hiển thị
        users.push(created);
        // Sau khi thêm, nhảy đến trang cuối
        const totalPages = Math.ceil(users.length / pageSize);
        currentPage = totalPages;
        renderUsers();
        renderPagination();
      } catch (err) {
        showError(err.message);
      }
    }

    // Update user (PUT)
    async function updateUser(id, updatedData) {
        try {
            clearError();

            // Kiểm tra user có tồn tại trên API hay không
            if (id > 10) {  // user mới tạo local
            // Cập nhật trên frontend
            users = users.map(u => (u.id === id ? {...u, ...updatedData} : u));
            renderUsers();
            renderPagination();
            return;
            }

            // Với user id 1-10 mới gọi API PUT
            const response = await fetch(`${API_URL}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData)
            });

            if (!response.ok) {
            throw new Error("Failed to update user. Status: " + response.status);
            }

            const updated = await response.json();

            // Cập nhật trên frontend
            users = users.map(u => (u.id === id ? updated : u));
            renderUsers();
            renderPagination();

        } catch (err) {
            showError(err.message);
        }
    }


    // Delete user (DELETE)
    async function deleteUser(id) {
      try {
        clearError();
        const response = await fetch(`${API_URL}/${id}`, {
          method: "DELETE"
        });

        if (!response.ok) {
          throw new Error("Failed to delete user. Status: " + response.status);
        }

        // Xóa trên frontend
        users = users.filter(u => u.id !== id);
        renderUsers();
        renderPagination();
      } catch (err) {
        showError(err.message);
      }
    }

    // Event listeners

    // Search
    searchInput.addEventListener("input", () => {
      currentPage = 1;
      renderUsers();
      renderPagination();
    });

    // Add User button
    btnAddUser.addEventListener("click", () => {
      openModal("create");
    });

    // Cancel in modal
    btnCancelModal.addEventListener("click", () => {
      closeModal();
    });

    // Submit form (Create / Edit)
    userForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = userIdInput.value ? Number(userIdInput.value) : null;
      const userData = {
        id: id || undefined, // id sẽ bị API ignore khi POST
        name: nameInput.value.trim(),
        email: emailInput.value.trim(),
        phone: phoneInput.value.trim()
      };

      if (!userData.name || !userData.email || !userData.phone) {
        showError("Please fill in all fields.");
        return;
      }

      if (id) {
        await updateUser(id, userData);
      } else {
        await createUser(userData);
      }

      closeModal();
    });

    // Delegate click for edit / delete buttons on table
    usersTableBody.addEventListener("click", (e) => {
      const target = e.target;

      if (target.classList.contains("btn-edit")) {
        const id = Number(target.getAttribute("data-id"));
        const user = users.find(u => u.id === id);
        if (user) {
          openModal("edit", user);
        }
      }

      if (target.classList.contains("btn-delete")) {
        const id = Number(target.getAttribute("data-id"));
        const confirmDelete = window.confirm("Are you sure you want to delete this user?");
        if (confirmDelete) {
          deleteUser(id);
        }
      }
    });

    // Init
    fetchUsers();
  </script>
</body>
</html>
